# 運用マニュアル (UVERworld Setlist Archive)

本アプリケーションの構成と、日々の開発から本番反映までの流れをまとめます。

## 1. サーバー構成

本プロジェクトは、安定性と実験性を両立させるための「ハイブリッド構成」を採用しています。

| 環境 | 実行方式 | ポート | データベース | 役割 |
| :--- | :--- | :--- | :--- | :--- |
| **本番 (Production)** | systemd (Bare Metal) | 8000 | ホスト上のPostgres (`uver_setlist_prod`) | ユーザーがアクセスする安定稼働環境 |
| **検証 (Staging)** | Docker Compose | 9000 | 容器内のPostgres (`uver_setlist_staging`) | 機能追加や破壊的変更のテスト環境 |

---

## 2. Git ブランチ戦略

本プロジェクトでは、環境とブランチを以下のように紐づけて管理します。個人開発でもこの構成をとることで、本番環境の安全性を高く保つことができます。

| ブランチ | 役割 | 紐づく環境 |
| :--- | :--- | :--- |
| **`main`** | **本番用**。常に動作が保証されたコードのみを置く。 | 本番環境 (Port 8000) |
| **`dev`** | **開発・検証用**。機能が統合される場所。 | 検証環境 (Port 9000) |
| **`feature/*`** | **作業用**。機能追加やバグ修正ごとに作成する。 | ローカル開発環境 |

### 基本的な流れ
1. `dev` から作業用ブランチ（例: `feature/add-search`）を作成。
2. 作業が終わったら `dev` にマージし、**検証環境（Docker）**で動作確認。
3. 検証環境で問題がなければ、`dev` を `main` にマージして**本番環境**に反映。

---

## 3. 開発・保守のワークフロー

### ① メインPC（ローカル）での作業
- **実装**: ローカル環境（`npm run dev`）でコードを書きます。
- **コミット**: 作業が区切りごとに `git commit` し、GitHubへ `push` します。
- **注意**: 本番に影響を与えないよう、基本的にはローカルのDBを使用してテストします。

### ② 検証環境（Staging）での動作確認
GitHubにプッシュした内容を、本番環境に反映させる前に**必ず**検証環境で確認します。

1. **最新化**: サーバー上の `~/apps/uver-setlist-staging` ディレクトリで `git pull` を行います。
2. **ビルド・起動**: `docker compose up -d --build` を実行し、最新イメージを作成・起動します。
3. **確認**: ブラウザで `http://192.168.0.13:9000` にアクセスし、新機能やデザインが崩れていないか、壊しても良いDBで存分にテストします。

### ③ 本番（Production）への反映
検証環境で「完璧」と判断したら、本番環境を更新します。

1. **最新化**: サーバー上の `~/apps/uver-setlist-app` ディレクトリで `git pull` を行います。
2. **ビルド**: `npm install` と `npm run build` を手動（またはスクリプト）で実行し、本番用ファイルを生成します。
3. **再起動**: `sudo systemctl restart uver-app-prod` を実行して、最新のコードを適用します。

---

## 3. 安全管理について

### データベースのバックアップ
- **自動化**: `cron` により、毎日深夜3時に本番DBのバックアップが `/home/haya-ryoo/backups/production` に保存されます。
- **保持期間**: 過去7日分が維持され、それより古いものは自動で削除されます。

### 将来の展望 (CI/CD)
現在は手動での引き上げ（pull）が必要ですが、将来的には GitHub Actions 等を利用し、「mainブランチにプッシュしたら自動でStagingが更新される」といった形に自動化することも可能です。

---

## 4. よく使うコマンド集

| 目的 | コマンド |
| :--- | :--- |
| 本番ステータス確認 | `systemctl status uver-app-prod` |
| 本番ログ確認 | `journalctl -u uver-app-prod -f` |
| 検証環境の再起動 | `cd ~/apps/uver-setlist-staging && docker compose up -d --build` |
| 手動バックアップ | `/home/haya-ryoo/scripts/backup_prod_db.sh` |
