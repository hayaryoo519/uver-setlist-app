# ã‚¤ãƒ³ãƒ•ãƒ©é‹ç”¨ãƒ»ç®¡ç†ã‚¬ã‚¤ãƒ‰ (Operations Manual)

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€`haya-ryooo.net` ã‚µãƒ¼ãƒãƒ¼ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã€ç¶­æŒç®¡ç†ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œã«é–¢ã™ã‚‹æƒ…å ±ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

---

## ðŸ— 1. ã‚µãƒ¼ãƒãƒ¼æ§‹æˆã¨ã‚¢ã‚¯ã‚»ã‚¹

### ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (Nginx)
Dockerã‚³ãƒ³ãƒ†ãƒŠ `web-nginx` ãŒãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦ç¨¼åƒã—ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŒ¯ã‚Šåˆ†ã‘ã¦ã„ã¾ã™ã€‚

| ãƒ‰ãƒ¡ã‚¤ãƒ³ | è»¢é€å…ˆ | ç”¨é€” |
|:---|:---|:---|
| **uver-setlist-archive.org** | Host Port `8000` | ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒªæœ¬ç•ª |
| **haya-ryooo.net** | `/usr/share/nginx/html` | å€‹äººã‚µã‚¤ãƒˆ |

- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `/home/haya-ryoo/web/nginx.conf`
- **è¨­å®šåæ˜ **: `docker exec web-nginx nginx -s reload`

### ãƒãƒ¼ãƒˆé–‹æ”¾ã¨ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å¤–éƒ¨å…¬é–‹ãƒãƒ¼ãƒˆã¯æœ€å°é™ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚

- **Public (ãƒ«ãƒ¼ã‚¿ãƒ¼/UFW)**: `80` (HTTP), `443` (HTTPS), `19132` (Minecraft)
- **Private (LAN only)**: `22` (SSH), `8000` (App Prod), `9000` (App Staging), `5432` (DB)

---

## ðŸ›¡ 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨

### ãƒ­ã‚°ã®ç›£è¦–
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹ã‚„ã‚¨ãƒ©ãƒ¼ã‚’ `security_logs` ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã—ã¦ã„ã¾ã™ã€‚

**ã‚³ãƒžãƒ³ãƒ‰ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œï¼‰:**
```bash
# æœ€æ–°ã®ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆç°¡æ˜“ï¼‰
node server/check_logs.js

# è©³ç´°åˆ†æžï¼ˆçµ±è¨ˆãƒ»æ”»æ’ƒå…ƒIPã®ç‰¹å®šï¼‰
node server/analyze_security.js
```

### åˆ¤æ–­åŸºæº–ã¨å¯¾å¿œ
| çŠ¶æ³ | åˆ¤æ–­ | å¯¾å¿œ |
|:---|:---|:---|
| 1æ—¥æ•°ä»¶ã®ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— | âœ… æ­£å¸¸ | ç›£è¦–ã®ã¿ |
| åŒä¸€IPã‹ã‚‰50å›žä»¥ä¸Šã®å¤±æ•— | ðŸš¨ **æ”»æ’ƒ** | IPãƒ–ãƒ­ãƒƒã‚¯ã€ãƒ­ã‚°ä¿å­˜ |
| æ·±å¤œã®å¤§é‡ã‚¢ã‚¯ã‚»ã‚¹ | ðŸš¨ **æ”»æ’ƒ** | è‡ªå‹•åŒ–Botã®å¯èƒ½æ€§ã€IPãƒ–ãƒ­ãƒƒã‚¯ |

### IPãƒ–ãƒ­ãƒƒã‚¯æ‰‹é † (Nginx)
`/home/haya-ryoo/web/nginx.conf` ã¾ãŸã¯ `block_ips.conf` ã«ä»¥ä¸‹ã‚’è¿½åŠ :
```nginx
deny 123.45.67.89;
```

---

## ðŸ’¾ 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©æ—§

### è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- **é »åº¦**: æ¯Žæ—¥æ·±å¤œ 3:00
- **å¯¾è±¡**: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (`uver_setlist_prod`)
- **ä¿å­˜å…ˆ**: `/home/haya-ryoo/backups/production`
- **ä¸–ä»£ç®¡ç†**: éŽåŽ»7æ—¥åˆ†ã‚’ä¿æŒ

### æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
pg_dump -U haya-ryoo uver_setlist_prod > backup_manual.sql
```

### ãƒªã‚¹ãƒˆã‚¢æ‰‹é †
```bash
psql -U haya-ryoo -d uver_setlist_prod < backup_file.sql
```

---

## ðŸš€ 4. ãƒ‡ãƒ—ãƒ­ã‚¤é‹ç”¨

### è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ (CI/CD)
GitHub Actionsã«ã‚ˆã‚Šã€ç‰¹å®šã®ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

- **æ¤œè¨¼ç’°å¢ƒ (Staging)**: `dev` ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§æ›´æ–°
- **æœ¬ç•ªç’°å¢ƒ (Production)**: `main` ã¸ã®ãƒžãƒ¼ã‚¸ï¼ˆã‚¿ã‚°ä½œæˆï¼‰æ™‚ã¯æ‰‹å‹•æ‰‹é †ãŒå«ã¾ã‚Œã‚‹å ´åˆã‚ã‚Šï¼ˆâ€»ç¾çŠ¶ã¯Workflowæ¬¡ç¬¬ï¼‰

### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é † (æœ¬ç•ª)
CI/CDãŒä½¿ãˆãªã„å ´åˆã®ç·Šæ€¥å¯¾å¿œæ‰‹é †ã§ã™ã€‚

1. **ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ­ã‚°ã‚¤ãƒ³**: `ssh haya-ryoo@192.168.0.13`
2. **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•**: `cd ~/apps/uver-setlist-app`
3. **æœ€æ–°åŒ–**: `git pull origin main`
4. **ä¾å­˜é–¢ä¿‚æ›´æ–°**: `npm install`
5. **ãƒ“ãƒ«ãƒ‰**: `npm run build`
6. **å†èµ·å‹•**: `sudo systemctl restart uver-app-prod`

---

## ðŸ“ ãƒ­ã‚°ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

| å¯¾è±¡ | ç¢ºèªã‚³ãƒžãƒ³ãƒ‰ |
|:---|:---|
| **Appç¨¼åƒçŠ¶æ³** | `systemctl status uver-app-prod` |
| **Appãƒ­ã‚°** | `journalctl -u uver-app-prod -f` |
| **Nginxãƒ­ã‚°** | `docker logs -f web-nginx` |

---
