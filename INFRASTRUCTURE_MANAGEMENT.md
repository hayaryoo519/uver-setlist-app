# インフラ運用・管理ガイド

このドキュメントは、`haya-ryooo.net` サーバーにおけるドメイン振り分け、セキュリティ設定、および環境管理のルールをまとめたものです。

---

## 1. ドメイン・ルーティング構成 (Nginx)

Nginx（コンテナ名: `web-nginx`）が、ドメイン名に基づいてリクエストを適切に振り分けています。

| ドメイン名 | 宛先 | 備考 |
|:---|:---|:---|
| `haya-ryooo.net` | ローカルディレクトリ (`/usr/share/nginx/html`) | 既存の個人サイト (HTTPS駆動) |
| `uver-setlist-archive.org` | ホストOSのポート **8000** | セットリストアプリ本番 (HTTPS駆動) |

### 設定ファイル
- **場所**: `/home/haya-ryoo/web/nginx.conf`
- **反映コマンド**:
  ```bash
  docker exec web-nginx nginx -s reload
  ```

---

## 2. セキュリティ・ネットワーク構成

### ルーター (ポートフォワーディング)
インターネットから直接アクセスできる「穴」を最小限に絞っています。
- **80 (TCP)** → 192.168.0.13:80 (Nginx入口)
- **443 (TCP)** → 192.168.0.13:443 (Nginx入口)
- **19132 (UDP)** → 192.168.0.13:19132 (Minecraft)

> [!IMPORTANT]
> **8000番や 9000番をルーターで直接開けてはいけません**。必ず Nginx (80/443) を経由させてください。

### サーバー内ファイアウォール (UFW)
- **外部公開**: 80, 443, 19132
- **ローカル限定 (192.168.0.0/24)**: SSH(22), 8000(アプリ直), 5432(DB)
- **Docker通信用**: `docker0` および `br-+` インターフェースからの通信は全て許可。

---

## 3. 環境の違いと「厳しさ」の理解

`npm run dev` (開発) と `npm run build` (本番) では、以下の点が大きく異なります。

### ① 構文チェックの厳密さ
- **dev**: 多少の文法的な矛盾や重複があっても、ブラウザ上で動けばスルーされます。
- **build**: 最適化と圧縮を行う際、1つの重複キー（例: `display: 'flex'` が2つある等）でもあれば、ビルドエラーとして停止します。

### ② エラーの波及
- **dev**: 特定のコンポーネントで JavaScript エラーが起きても、そこだけ表示されない、またはエラー画面が出るだけで済みます。
- **build**: 本番用コードは一箇所のエラー（例: `undefined` を `split()` しようとする等）が原因で、**画面全体が真っ白 (White Screen of Death)** になる可能性が高いです。
  - **対策**: `live.date ? live.date.split(...) : ''` のようなガードを徹底すること。

### ③ セキュリティ設定 (Helmet)
- **Staging/Production**: セキュリティヘッダー (`Helmet`) が有効になります。
- **挙動**: 不適切な外部スクリプトの読み込みや、IPアドレスによる直接アクセス時のリソース遮断が発生しやすくなります。

---

## 5. 開発・デプロイ ワークフロー (Git)

「サーバー上で直接ファイルを編集しない」ことが、環境を壊さないための最大の防御です。

### 基本ルール
1.  **作業は必ずローカル (Windows PC) で開始**: `npm run dev` で動作を確認。
2.  **サーバー上での直接編集は禁止**: コンフリクトや「何を変えたか分からない」状態を防ぐため。
3.  **検証環境を経由**: 本番反映前に必ず `staging` 環境で `npm run build` を通す。

---

### シーン別：ブランチの使い分け

| 修正の規模 | 推奨アクション | 理由 |
|:---|:---|:---|
| **小規模** (誤字脱字、CSS 1行など) | `dev` ブランチに直接コミットして Push | スピード優先。壊れるリスクが極めて低いため。 |
| **中・大規模** (新機能、バグ修正、DB変更) | **作業用ブランチ** を作成 (例: `feat-login`) | 失敗しても `dev` ブランチを汚さず、やり直しやすいため。 |

### 推奨手順 (中・大規模時)
1.  ローカルで新ブランチ作成: `git checkout -b feat-xxx`
2.  開発 & テスト
3.  `dev` にマージして Push:
    ```powershell
    git checkout dev
    git merge feat-xxx
    git push origin dev
    ```
4.  検証環境 (サーバー) で `git pull` してテスト
5.  問題なければ `v1.x.x` のタグを打って本番デプロイ

---

### 万が一、検証環境で直接いじりたくなったら？
「どうしてもコンテナの中やサーバー上で1行だけ変えて試したい」という衝動に駆られたら、**試した後に必ずローカルのコードに同じ修正を反映させてコミット**してください。
サーバー上で `git pull` した時にエラーが出る原因の 9 割は、サーバー側のファイルを直接書き換えてしまったことによる競合です。
